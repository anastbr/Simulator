---
title: "Smilator_omics"
author: "Anastasia&Nasimeh"
date: "6/27/2022"
output: html_document
---
# Simulator code for data generation process of omics data. 


## Anastasia_Simulator

# Purpose: -->
# Simulating methylation data based on real-world data. Replicates the data generating process of real-world data using simulation parameters #(e.g. number of samples) and generates a synthetic dataset with induced treatment effects.  -->

# Result: -->
# A beta matrix is equivalent to a real-world matrix with adjusted values.  -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(GEOquery) #bioconductor

```


```{r, message=FALSE, cache=FALSE, echo=FALSE,warning=FALSE}
GEO_real_world_data <- "GSE145714" # ID for real world data 
gset <- getGEO(GEO_real_world_data, GSEMatrix =TRUE, getGPL=FALSE, destdir="example_dataset/")
gset <- gset$GSE145714_series_matrix.txt.gz

clinical_data <- pData(gset) # clinico-pathological description
clinical_data <- clinical_data[,c(2,41:44)]
colnames(clinical_data)[c(2:5)] <- c("hiv_status", "gender", "tb_status", "timepoint")
clinical_data <- clinical_data[order(clinical_data$tb_status),]
beta_matrix <- exprs(gset)
rm(gset)

#selecting testing data
beta_matrix = beta_matrix[sample(nrow(beta_matrix), 1000, replace = FALSE), ]
```

```{r pressure, echo=FALSE}
#default parameters for the simulator
num_samples <- 500
healthy_proportion <- 0.5
num_true_modified <- 100
treatment_effect <- 0.3
user_specified_n_CpGs <- 1200

```

```{r pressure, echo=FALSE}
# Function for calculating the mean of CpGs across all samples.
calculate_means <- function (beta_values_matrix) {
# check stop if not() to make sure there are no non numeric values.
means <- rowMeans(beta_values_matrix, na.rm=TRUE)# if all values within a row are NA produces NaN
means <- na.omit(means) #add handling of NAs if values in the the vector are NAs
return(means)
}
```

```{r pressure, echo=FALSE}
# Function for calculating the standard deviation of CpGs across all samples.
calculate_SD <- function (beta_values_matrix) {
SD <- matrixStats::rowSds(beta_values_matrix, na.rm=TRUE)
SD <- na.omit(SD) #add handling of NAs if values in the the vector are NAs
return(SD)
}
```

```{r pressure, echo=FALSE}
#combining means asn SDs as one object 
means_real_world =calculate_means(beta_matrix)
SD_real_world=calculate_SD(beta_matrix)
means_SD_real_world=cbind(m,s)

```

```{r pressure, echo=FALSE}
# function _means_list_user_defined (generate new vector of means and SDs of CpGs based on user input, means and SDs of beta_matrix)
#return(mean,sd)
set.seed(42)

user_specified_num_elements <- function(means, user_specified_n_CpGs){
sampling_indices = sample(1:dim(c)[1],user_specified_n_CpGs, replace = TRUE)
return(sampling_indices)
}


```


```{r pressure, echo=FALSE}
indices = user_specified_num_elements(means_SD_real_world)
means_SD = means_SD_real_world %in% 
```


```{r pressure, echo=FALSE}

#  Function to calculate distribution parameters for groups
distribution_parameters <- function(means, treatment_effect){ #introduce_treatment_effect?
  #inducing_group_differences 
  #num_samples,healthy_proportion,num_true_mutated (extra parameters not yet included)

prob_group_annotation <- sample(0:1, size=length(means), replace = T)  # creating vector of zero and 1 which represents assign groups

record = vector()
gr_2 = means # empty vector to store adjusted  means
for(i in 1:length(means)){ #runs through every mean values of each CpG site
  print(i)
  if(prob_group_annotation[i] == 1){ #selecting group 1 
    record [i] = TRUE
    if(gr_2[i] + treatment_effect>=1){ #adjusting changed value within its boundaries
     gr_2[i] = 1 
    }
    if(gr_2[i] + treatment_effect>0 & gr_2[i] + treatment_effect<1){ 
      gr_2[i] = gr_2[i] + treatment_effect #adding the treatment effect to clinical population
    }
 
  }
  else if(prob_group_annotation[i]==0){ #reference group
    record [i] = FALSE
      gr_2[i] = gr_2[i] #when prob_group_annotation is zero we don't make any change - equal to itself 
  }
   #print(record)
}
#str(gr_1)
#str(gr_2)
  return(gr_2)
#write.table(record, file ='recorded_located_treatment_effect.txt')
}

```

```{r pressure, echo=FALSE}
means = calculate_means(beta_matrix) #calling function calculating means of CpGs across all samples 
SDs = calculate_SD(beta_matrix) #calling function calculating SDs of CpGs across all samples
means = na.omit(means) 
SDs= na.omit(SDs)

gr_1 = means #(reference group)

gr_2 = distribution_parameters(means, treatment_effect)

```


```{r pressure, echo=FALSE}
gr_2_mean <- calculate_means(gr_2) # The output fro the for loop is a vector of means + treatment effect, it does not seems reasonable to calculate mean of mean

```


```{r pressure, echo=FALSE}
#Get sample distribution of groups 

sample_distribution <- function(means_vector,SDs_vector,num_samples, healthy_proportion){
  store_sample_dist = matrix(ncol=num_samples,nrow = length(means))
  for (i in 1:num_samples){
   ind_sample=rnorm(n=length(means),mean=means,sd=SDs) 
   store_sample_dist[,i] =ind_sample
  }
  return(store_sample_dist)
}

gr_1_dist_matrix = sample_distribution(gr_1, SDs,healthy_proportion*num_samples)
gr_2_dist_matrix = sample_distribution(gr_2, SDs,(1-healthy_proportion)*num_samples)

combined_samples = cbind(gr_1_dist_matrix, gr_2_dist_matrix)

#write.table(combined_samples,file='simulated_data.txt')

```

