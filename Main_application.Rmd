---
title: "Smilator_omics"
author: "Anastasia&Nasimeh"
date: "6/27/2022"
output: html_document
---
# Simulator code for data generation process of omics data. 


## Anastasia_Simulator

# Purpose: -->
# Simulating methylation data based on real-world data. Replicates the data generating process of real-world data using simulation parameters #(e.g. number of samples) and generates a synthetic dataset with induced treatment effects.  -->

# Result: -->
# A beta matrix is equivalent to a real-world matrix with adjusted values.  -->

```{r pressure, echo=FALSE}
# Function for calculating the mean of CpGs across all samples.
calculate_means <- function (beta_values_matrix) {
# check stop if not() to make sure there are no non numeric values.
means <- rowMeans(beta_values_matrix, na.rm=TRUE)# if all values within a row are NA produces NaN
means <- na.omit(means) #add handling of NAs if values in the the vector are NAs
print(head(means))
return(means)
}
```

```{r pressure, echo=FALSE}
# Function for calculating the standard deviation of CpGs across all samples.
calculate_SD <- function (beta_values_matrix) {
SD <- matrixStats::rowSds(beta_values_matrix, na.rm=TRUE)
SD <- na.omit(SD) #add handling of NAs if values in the the vector are NAs
print(head(SD))
return(SD)
}
```


```{r pressure, echo=FALSE}
# function _means_list_user_defined (generate new vector of means and SDs of CpGs based on user input, means and SDs of beta_matrix)
#return(mean,sd)
set.seed(42)

user_specified_num_elements <- function(means, user_specified_n_CpGs){
sampling_indices = sample(1:dim(means)[1],user_specified_n_CpGs, replace = TRUE)
print(head(sampling_indices))
return(sampling_indices)
}


```


```{r pressure, echo=FALSE}

induce_group_differnces <- function(num_true_modified, vector_of_ref_means, effect_size, user_path){ #record=T
set.seed(42)
  
truly_different_indices <- sample(1:length(vector_of_ref_means), size=num_true_modified, replace = FALSE)
filename <- paste0(user_path, '/truly_different_sites_indices.txt')
write.table(truly_different_indices, filename, row.names = FALSE, col.names = FALSE, sep = " ")
vector_of_affected_means <- vector_of_ref_means
vector_of_affected_means[truly_different_indices] <- vector_of_ref_means[truly_different_indices]+effect_size
vector_of_affected_means <- ifelse(vector_of_affected_means>1, 1, vector_of_affected_means)
return(list(vector_of_affected_means,truly_different_indices))
}
```



```{r pressure, echo=FALSE}
get_group_number = function(healthy_proportion, total_num_samples){
g1_number_of_samples = healthy_proportion*total_num_samples
g2_number_of_samples = total_num_samples-g1_number_of_samples
g1_g2 = c(g1_number_of_samples ,g2_number_of_samples)
names(g1_g2) = c('Reference','Diseased')
return(g1_g2)
}

```



```{r pressure, echo=FALSE}
sample_distribution = function(means_vector, sds_vector, number_of_samples_in_group){
  all_cpgs <- c()
  cpg_name <- c()
for(i in 1:length(means_vector)){
cpg_i <- rnorm(number_of_samples_in_group, mean = means_vector[i], sd = sds_vector[i])
cpg_name[i] <- paste0("cpg",i)
all_cpgs <- rbind(all_cpgs,cpg_i)
#print(all_cpgs)
}
for (j in 1: length(all_cpgs)){
  if (all_cpgs[j] > 1){
  all_cpgs[j] = max(beta_matrix, na.rm = T)
  } else if (all_cpgs[j]< 0 || is.negative(all_cpgs[j])){
 all_cpgs[j]= min(beta_matrix, na.rm=T)
  } 
  }

rownames(all_cpgs) <- cpg_name
print(head(all_cpgs))
return(all_cpgs)
}
```


```{r pressure, echo=FALSE}
generate_cpgs_for_groups = function(g1_means_vector, g2_means_vector, vector_sd, g1_number_of_samples, g2_number_of_samples){
g1_cpgs <- sample_distribution(g1_means_vector, vector_sd, g1_number_of_samples)
g2_cpgs <- sample_distribution(g2_means_vector, vector_sd, g2_number_of_samples)
cpgs <- cbind(g1_cpgs, g2_cpgs)
print(head(cpgs))
return(cpgs)
}
```

```{r pressure, echo=FALSE}
generate_col_names = function(data_frame,g1_number_of_samples,g2_number_of_samples){
  g1_sample_names= paste0("Gr1_Samp",1:g1_number_of_samples)
  g2_sample_names= paste0("Gr2_Samp",1:g2_number_of_samples)
  all_sample_names = c(g1_sample_names, g2_sample_names)
}
```

```{r pressure, echo=FALSE}
get_all_combinations = function(total_num_samples_vector,effect_size_vector,healthy_proportion,num_true_modified,user_specified_n_CpGs,user_path, zip_file_name){
all_combinations = expand.grid(total_num_samples_vector,effect_size_vector,healthy_proportion,num_true_modified,user_specified_n_CpGs)
all_combinations$Va6 = user_path
all_combinations$Var7 = paste0(zip_file_name,1:nrow(all_combinations))
write.csv(all_combinations,"all_combinations.csv")
print(head(all_combinations))
return(all_combinations)
}

#test <- get_all_combinations(total_num_samples_vector,effect_size_vector,healthy_proportion,num_true_modified,user_specified_n_CpGs,user_path, zip_file_name)

```

```{r pressure, echo=FALSE}
create_zip = function(user_path,zip_file_name){
  path_directory = user_path
  zipfile = paste0(user_path,"/",zip_file_name,".zip")
  my_files = c(paste0(user_path,"/Simulated_data.txt"),paste0(user_path,"/truly_different_sites_indices.txt"),paste0(user_path,"/User_Parameters.txt"))
  zip::zipr(zipfile = zipfile, files = my_files) 
}
```

```{r pressure, echo=FALSE}

library(schoolmath)
library(GEOquery) #bioconductor
library(purrr) #For create cartesian product (Get all parameter combinations)
library(zip)
library(matrixStats)


```

```{r pressure, echo=FALSE}
GEO_real_world_data <- "GSE145714" # ID for real world data 

gset <- getGEO(GEO_real_world_data, GSEMatrix =TRUE, getGPL=FALSE, destdir="example_dataset/")

gset <- gset$GSE145714_series_matrix.txt.gz

clinical_data <- pData(gset) # clinico-pathological description

clinical_data <- clinical_data[,c(2,41:44)]

colnames(clinical_data)[c(2:5)] <- c("hiv_status", "gender", "tb_status", "timepoint")

clinical_data <- clinical_data[order(clinical_data$tb_status),]

beta_matrix <- exprs(gset)

#beta_matrix <-beta_matrix[1:5000,1:10]

rm(gset)

#selecting testing data
#beta_matrix = beta_matrix[sample(nrow(beta_matrix), 1000, replace = FALSE), ]
```

#simulator = function(total_num_samples,effect_size,healthy_proportion,num_true_modified,user_specified_n_CpGs,user_path, zip_file_name){
#combining means asn SDs as one object 
#Creating data based on user defined CpGs through sampling of emans and SDs of the real world data
#Introducing effect size and thus creating two groups.
#Create matrix of beta values for the user defined number of samples per group
# Save the running parameters, simultaed methylation data matrix, and the truly differentially methylated CpG sites.


```{r pressure, echo=FALSE}

simulator = function(combined_param_vector){ 
total_num_samples = as.numeric(combined_param_vector[1])
effect_size = as.numeric(combined_param_vector[2])
healthy_proportion = as.numeric(combined_param_vector[3])
num_true_modified = as.numeric(combined_param_vector[4])
user_specified_n_CpGs = as.numeric(combined_param_vector[5])
user_path = combined_param_vector[6]
zip_file_name = combined_param_vector[7]
means_real_world = calculate_means(beta_matrix)
SD_real_world = calculate_SD(beta_matrix)
means_SD_real_world = cbind(means_real_world,SD_real_world)


indices = user_specified_num_elements(means_SD_real_world, user_specified_n_CpGs)
means_SD = means_SD_real_world[indices,] 
vector_of_ref_means = means_SD[,1]
vector_sd = means_SD[,2]


list_indices_affected_means = induce_group_differnces(num_true_modified,vector_of_ref_means,effect_size,user_path)
vector_of_affected_means = list_indices_affected_means[[1]]

g1_number_of_samples=get_group_number(healthy_proportion, total_num_samples)[1]
g2_number_of_samples=get_group_number(healthy_proportion, total_num_samples)[2]


simulated_data = generate_cpgs_for_groups(vector_of_ref_means,vector_of_affected_means, vector_sd, g1_number_of_samples, g2_number_of_samples)

colnames(simulated_data) = generate_col_names(simulated_data,g1_number_of_samples,g2_number_of_samples) #check this 

file_name_simulated_data = paste0(user_path,"/Simulated_data.txt")
write.table(simulated_data, file_name_simulated_data,col.names = TRUE, row.names = TRUE)

param_names = c("Total number of samples","User-spesified number of CpGs","Healthy proportion","Effect size","Number of true modified CpG sites")
param_values = c(total_num_samples,user_specified_n_CpGs,healthy_proportion,effect_size,num_true_modified)
param_summary <- as.data.frame(matrix(nrow = length(param_names), ncol = 2))

names(param_summary) = c("Parameter","Value")
param_summary$Parameter = param_names
param_summary$Value = param_values

file_name_parameters = paste0(user_path,"/User_Parameters.txt")
write.table(param_summary,file_name_parameters,row.names = FALSE, col.names = TRUE, sep = " ")

create_zip(user_path,zip_file_name)
}

```


```{r pressure, echo=FALSE}

multi_SimMethyl = function(total_num_samples_vector,effect_size_vector,healthy_proportion,num_true_modified,user_specified_n_CpGs,user_path,zip_file_name){
combination_df = get_all_combinations(total_num_samples_vector,effect_size_vector,healthy_proportion,num_true_modified,user_specified_n_CpGs,user_path,zip_file_name)
final_output <- apply(combination_df, 1, simulator)
return(final_output)
}

```

```{r pressure, echo=FALSE}
start.time <- Sys.time()
print(paste0("Start Time ", start.time))

user_path = getwd() #"/Users/sima/Documents/summer project/Simulator")
zip_file_name ="SimMethyl_run_"


healthy_proportion <- 0.5
num_true_modified <- c(10,30,60,120,200)

user_specified_n_CpGs <- 2500

total_num_samples_vector <- c(20,60,100,140,180,220,260)
effect_size_vector <- 0.05

multi_SimMethyl(total_num_samples_vector,effect_size_vector,healthy_proportion,num_true_modified,user_specified_n_CpGs,user_path,zip_file_name)

end.time <- Sys.time()
print(paste0("End Time ", end.time))
time.taken <- end.time - start.time
print(paste0("Time Taken ", time.taken))
```


