---
title: "Smilator_omics"
author: "Anastasia&Nasimeh"
date: "6/27/2022"
output: html_document
---
# Simulator code for data generation process of omics data. 


## Anastasia_Simulator

# Purpose: -->
# Simulating methylation data based on real-world data. Replicates the data generating process of real-world data using simulation parameters #(e.g. number of samples) and generates a synthetic dataset with induced treatment effects.  -->

# Result: -->
# A beta matrix is equivalent to a real-world matrix with adjusted values.  -->

```{r pressure, echo=FALSE}
# Function for calculating the mean of CpGs across all samples.
calculate_means <- function (beta_values_matrix) {
# check stop if not() to make sure there are no non numeric values.
means <- rowMeans(beta_values_matrix, na.rm=TRUE)# if all values within a row are NA produces NaN
means <- na.omit(means) #add handling of NAs if values in the the vector are NAs
return(means)
}
```

```{r pressure, echo=FALSE}
# Function for calculating the standard deviation of CpGs across all samples.
calculate_SD <- function (beta_values_matrix) {
SD <- matrixStats::rowSds(beta_values_matrix, na.rm=TRUE)
SD <- na.omit(SD) #add handling of NAs if values in the the vector are NAs
return(SD)
}
```


```{r pressure, echo=FALSE}
# function _means_list_user_defined (generate new vector of means and SDs of CpGs based on user input, means and SDs of beta_matrix)
#return(mean,sd)
set.seed(42)

user_specified_num_elements <- function(means, user_specified_n_CpGs){
sampling_indices = sample(1:dim(means)[1],user_specified_n_CpGs, replace = TRUE)
return(sampling_indices)
}


```


```{r pressure, echo=FALSE}

induce_group_differnces <- function(num_true_modified, vector_of_ref_means, effect_size, path_to_record_truly_different_indices){ #record=T
set.seed(42)
  
truly_different_indices <- sample(1:length(vector_of_ref_means), size=num_true_modified, replace = FALSE)
filename <- paste0(path_to_record_truly_different_indices, '/truly_different_sites_indices.txt')
write.table(truly_different_indices, filename)
vector_of_affected_means <- vector_of_ref_means
vector_of_affected_means[truly_different_indices] <- vector_of_ref_means[truly_different_indices]+effect_size
vector_of_affected_means <- ifelse(vector_of_affected_means>1, 1, vector_of_affected_means)
return(list(vector_of_affected_means,truly_different_indices))
}
```



```{r pressure, echo=FALSE}
get_group_number = function(healthy_proportion, total_num_samples){
g1_number_of_samples = healthy_proportion*total_num_samples
g2_number_of_samples = total_num_samples-g1_number_of_samples
ref_diff = c(g1_number_of_samples ,g2_number_of_samples)
names(ref_diff) = c('Reference','Diseased')
return(ref_diff)
}

```



```{r pressure, echo=FALSE}
sample_distribution = function(means_vector, sds_vector, number_of_samples_in_group){
  all_cpgs <- c()
for(i in 1:length(means_vector)){
cpg_i <- rnorm(number_of_samples_in_group, mean = means_vector[i], sd = sds_vector[i])
all_cpgs <- rbind(all_cpgs,cpg_i)
}
return(all_cpgs)
}
```


```{r pressure, echo=FALSE}
generate_cpgs_for_groups = function(g1_means_vector, g2_means_vector, vector_sd, g1_number_of_samples, g2_number_of_samples){
g1_cpgs <- sample_distribution(g1_means_vector, vector_sd, g1_number_of_samples)
g2_cpgs <- sample_distribution(g2_means_vector, vector_sd, g2_number_of_samples)
cpgs <- cbind(g1_cpgs, g2_cpgs)
return(cpgs)
}

```


```{r, message=FALSE, cache=FALSE, echo=FALSE,warning=FALSE}
#default parameters for the simulator
total_num_samples <- 500
healthy_proportion <- 0.5
num_true_modified <- 100
effect_size <- 0.3
user_specified_n_CpGs <- 1200
```

```{r pressure, echo=FALSE}

library(GEOquery) #bioconductor
```

```{r pressure, echo=FALSE}
GEO_real_world_data <- "GSE145714" # ID for real world data 
gset <- getGEO(GEO_real_world_data, GSEMatrix =TRUE, getGPL=FALSE, destdir="example_dataset/")
gset <- gset$GSE145714_series_matrix.txt.gz

clinical_data <- pData(gset) # clinico-pathological description
clinical_data <- clinical_data[,c(2,41:44)]
colnames(clinical_data)[c(2:5)] <- c("hiv_status", "gender", "tb_status", "timepoint")
clinical_data <- clinical_data[order(clinical_data$tb_status),]
beta_matrix <- exprs(gset)
rm(gset)

#selecting testing data
beta_matrix = beta_matrix[sample(nrow(beta_matrix), 1000, replace = FALSE), ]
```

```{r pressure, echo=FALSE}
simulator = function(total_num_samples,healthy_proportion,num_true_modified,user_specified_n_CpGs,effect_size, user_path){
  
#combining means asn SDs as one object 
means_real_world = calculate_means(beta_matrix)
SD_real_world = calculate_SD(beta_matrix)
means_SD_real_world = cbind(means_real_world,SD_real_world)

indices = user_specified_num_elements(means_SD_real_world, user_specified_n_CpGs)
means_SD = means_SD_real_world[indices,]
vector_of_ref_means = means_SD[,1]
vector_sd = means_SD[,2]

user_path ="C:/Users/anast/Documents/Master 2021/Summer project 2022"
list_indices_affected_means = induce_group_differnces(num_true_modified,vector_of_ref_means,effect_size,user_path)
vector_of_affected_means = list_indices_affected_means[[1]]

g1_number_of_samples=get_group_number(healthy_proportion, total_num_samples)[1]
g2_number_of_samples=get_group_number(healthy_proportion, total_num_samples)[2]

simulated_data = generate_cpgs_for_groups(vector_of_ref_means,vector_of_affected_means, vector_sd, g1_number_of_samples, g2_number_of_samples)
file_name = paste0(user_path,"/Simulated data.txt")
write.table(simulated_data, file_name,col.names = FALSE, row.names = FALSE)
}
```





